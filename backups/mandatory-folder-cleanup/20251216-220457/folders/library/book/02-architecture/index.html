<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Technical architecture of EVA Chat 2.0: React 18 components, EVA Foundation API, Azure OpenAI integration, RAG pipeline, and deployment topology"><meta name=author content=MarcoPolo483><link href=https://marcopolo483.github.io/eva-orchestrator/book/02-architecture/ rel=canonical><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.3"><title>Chapter 02: Architecture - EVA Suite</title><link rel=stylesheet href=../../assets/stylesheets/main.50c56a3b.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=red data-md-color-accent=red> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#chapter-02-architecture class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="EVA Suite" class="md-header__button md-logo" aria-label="EVA Suite" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> EVA Suite </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Chapter 02: Architecture </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=red data-md-color-accent=red aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=red data-md-color-accent=red aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/MarcoPolo483/eva-orchestrator title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> eva-orchestrator </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../eva-library/ class=md-tabs__link> EVA Library </a> </li> <li class=md-tabs__item> <a href=../ class=md-tabs__link> EVA Agentic Book </a> </li> <li class=md-tabs__item> <a href=../../eva-sovereign-ui-book/00-introduction/ class=md-tabs__link> EVA Sovereign UI Book </a> </li> <li class=md-tabs__item> <a href=../../compliance/ class=md-tabs__link> Compliance </a> </li> <li class=md-tabs__item> <a href=../../architecture/roadmap.md class=md-tabs__link> Architecture </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="EVA Suite" class="md-nav__button md-logo" aria-label="EVA Suite" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> EVA Suite </label> <div class=md-nav__source> <a href=https://github.com/MarcoPolo483/eva-orchestrator title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> eva-orchestrator </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> EVA Library </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> EVA Library </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../eva-library/ class=md-nav__link> <span class=md-ellipsis> Overview </span> <span class="md-status md-status--production"></span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex> <span class=md-ellipsis> Components </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Components </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../eva-library/components/button.md class=md-nav__link> <span class=md-ellipsis> Button </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/components/input.md class=md-nav__link> <span class=md-ellipsis> Input </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/components/select.md class=md-nav__link> <span class=md-ellipsis> Select </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/components/checkbox.md class=md-nav__link> <span class=md-ellipsis> Checkbox </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/components/radio.md class=md-nav__link> <span class=md-ellipsis> Radio </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/components/modal.md class=md-nav__link> <span class=md-ellipsis> Modal </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/components/tabs.md class=md-nav__link> <span class=md-ellipsis> Tabs </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/components/card.md class=md-nav__link> <span class=md-ellipsis> Card </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/components/alert.md class=md-nav__link> <span class=md-ellipsis> Alert </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/components/chat-panel.md class=md-nav__link> <span class=md-ellipsis> Chat Panel </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex> <span class=md-ellipsis> Framework Integration </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Framework Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../eva-library/frameworks/react.md class=md-nav__link> <span class=md-ellipsis> React </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/frameworks/vue.md class=md-nav__link> <span class=md-ellipsis> Vue </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/frameworks/angular.md class=md-nav__link> <span class=md-ellipsis> Angular </span> </a> </li> <li class=md-nav__item> <a href=../../eva-library/frameworks/svelte.md class=md-nav__link> <span class=md-ellipsis> Svelte </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> EVA Agentic Book </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> EVA Agentic Book </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/00-front-matter/ class=md-nav__link> <span class=md-ellipsis> Front Matter </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/01-introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/02-eva-philosophy/ class=md-nav__link> <span class=md-ellipsis> EVA Philosophy </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/03-pods-lifecycle/ class=md-nav__link> <span class=md-ellipsis> Pods & Lifecycle </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/04-safety-governance/ class=md-nav__link> <span class=md-ellipsis> Safety & Governance </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/05-eva-universe/ class=md-nav__link> <span class=md-ellipsis> EVA Universe - The Complete Vision </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/06-orchestration/ class=md-nav__link> <span class=md-ellipsis> Orchestration </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/07-workflows/ class=md-nav__link> <span class=md-ellipsis> Workflows </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/08-agent-handbook/ class=md-nav__link> <span class=md-ellipsis> Agent Handbook </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/09-provenance-fingerprinting/ class=md-nav__link> <span class=md-ellipsis> Provenance & Fingerprinting </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/10-case-studies/ class=md-nav__link> <span class=md-ellipsis> Case Studies </span> </a> </li> <li class=md-nav__item> <a href=../../eva-agentic-book/11-appendices/ class=md-nav__link> <span class=md-ellipsis> Appendices </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_14> <label class=md-nav__link for=__nav_3_14 id=__nav_3_14_label tabindex> <span class=md-ellipsis> GC Agentic AI Framework </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_14_label aria-expanded=false> <label class=md-nav__title for=__nav_3_14> <span class="md-nav__icon md-icon"></span> GC Agentic AI Framework </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../agentic/EVA%20Canada%20Agentic%20AI%20Template%20vol0%20-%20how-to/ class=md-nav__link> <span class=md-ellipsis> Volume 0 - Overview & How-To </span> </a> </li> <li class=md-nav__item> <a href=../../agentic/EVA%20Canada%20Agentic%20AI%20Template%20vol1/ class=md-nav__link> <span class=md-ellipsis> Volume 1 - Platform & Requirements </span> </a> </li> <li class=md-nav__item> <a href=../../agentic/EVA%20Canada%20Agentic%20AI%20Template%20vol2/ class=md-nav__link> <span class=md-ellipsis> Volume 2 - Engineering & Delivery </span> </a> </li> <li class=md-nav__item> <a href=../../agentic/EVA%20Canada%20Agentic%20AI%20Template%20vol3/ class=md-nav__link> <span class=md-ellipsis> Volume 3 - LiveOps & Governance </span> </a> </li> <li class=md-nav__item> <a href=../../agentic/EVA%20Canada%20Agentic%20AI%20Template%20vol4/ class=md-nav__link> <span class=md-ellipsis> Volume 4 - Use Cases & Patterns </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_15> <label class=md-nav__link for=__nav_3_15 id=__nav_3_15_label tabindex> <span class=md-ellipsis> DevTools Patterns (P01-P22) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_15_label aria-expanded=false> <label class=md-nav__title for=__nav_3_15> <span class="md-nav__icon md-icon"></span> DevTools Patterns (P01-P22) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../agents/devtools/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P01-Agent-Patterns-Toolbox/ class=md-nav__link> <span class=md-ellipsis> P01 - Agent Patterns Toolbox </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P02-Requirements-Engine/ class=md-nav__link> <span class=md-ellipsis> P02 - Requirements Engine </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P03-Scrum-Agent/ class=md-nav__link> <span class=md-ellipsis> P03 - Scrum Agent </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P04-Repo-Librarian/ class=md-nav__link> <span class=md-ellipsis> P04 - Repo Librarian </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P05-Scaffolder-Agent/ class=md-nav__link> <span class=md-ellipsis> P05 - Scaffolder Agent </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P06-Review-Agent/ class=md-nav__link> <span class=md-ellipsis> P06 - Review Agent </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P07-Testing-Failure-Explainer/ class=md-nav__link> <span class=md-ellipsis> P07 - Testing & Failure Explainer </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P08-CICD-Guardian/ class=md-nav__link> <span class=md-ellipsis> P08 - CI/CD Guardian </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P09-Runbook-SRE-Agent/ class=md-nav__link> <span class=md-ellipsis> P09 - Runbook & SRE Agent </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P10-Metrics-Insight-Agent/ class=md-nav__link> <span class=md-ellipsis> P10 - Metrics & Insight Agent </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P11-Security-Compliance-Helper/ class=md-nav__link> <span class=md-ellipsis> P11 - Security & Compliance Helper </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P12-UX-Copy-Accessibility-Agent/ class=md-nav__link> <span class=md-ellipsis> P12 - UX, Copy & Accessibility Agent </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P13-Onboarding-Sandbox-Coach/ class=md-nav__link> <span class=md-ellipsis> P13 - Onboarding & Sandbox Coach </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P14-DevOps-LiveOps-Companion/ class=md-nav__link> <span class=md-ellipsis> P14 - DevOps LiveOps Companion </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P15-Dev-Master-Orchestrator/ class=md-nav__link> <span class=md-ellipsis> P15 - Dev Master Orchestrator </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P16-Awareness-Protocol/ class=md-nav__link> <span class=md-ellipsis> P16 - Awareness Protocol </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P17-Swarm-PR-Review/ class=md-nav__link> <span class=md-ellipsis> P17 - Swarm PR Review </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P18-Tool-API-Auto-Onboarding/ class=md-nav__link> <span class=md-ellipsis> P18 - Tool/API Auto-Onboarding </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P19-Action-Classification-Safety/ class=md-nav__link> <span class=md-ellipsis> P19 - Action Classification & Safety </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P20-Continuous-Self-Improvement/ class=md-nav__link> <span class=md-ellipsis> P20 - Continuous Self-Improvement </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P21-Provenance-Fingerprinting/ class=md-nav__link> <span class=md-ellipsis> P21 - Provenance & Fingerprinting </span> </a> </li> <li class=md-nav__item> <a href=../../agents/devtools/P22-Documentation-Publishing-Bot/ class=md-nav__link> <span class=md-ellipsis> P22 - Documentation Publishing Bot </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_16> <label class=md-nav__link for=__nav_3_16 id=__nav_3_16_label tabindex> <span class=md-ellipsis> Service Personas (SP00-SP02) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_16_label aria-expanded=false> <label class=md-nav__title for=__nav_3_16> <span class="md-nav__icon md-icon"></span> Service Personas (SP00-SP02) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../agents/personas/SP00-Senior-Advisor/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../agents/personas/SP01-Data-Ingestion/ class=md-nav__link> <span class=md-ellipsis> SP01 - Data Ingestion </span> </a> </li> <li class=md-nav__item> <a href=../../agents/personas/SP02-ATO-Auditor/ class=md-nav__link> <span class=md-ellipsis> SP02 - ATO Auditor </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> EVA Sovereign UI Book </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> EVA Sovereign UI Book </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/00-introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/01-getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/02-design-principles/ class=md-nav__link> <span class=md-ellipsis> Design Principles </span> </a> </li> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/03-components-overview/ class=md-nav__link> <span class=md-ellipsis> Components Overview </span> </a> </li> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/04-api-reference/ class=md-nav__link> <span class=md-ellipsis> API Reference </span> </a> </li> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/05-usage-examples/ class=md-nav__link> <span class=md-ellipsis> Usage Examples </span> </a> </li> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/06-accessibility/ class=md-nav__link> <span class=md-ellipsis> Accessibility </span> </a> </li> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/07-internationalization/ class=md-nav__link> <span class=md-ellipsis> Internationalization </span> </a> </li> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/08-theming/ class=md-nav__link> <span class=md-ellipsis> Theming </span> </a> </li> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/09-contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> <span class="md-status md-status--published"></span> </a> </li> <li class=md-nav__item> <a href=../../eva-sovereign-ui-book/10-appendices/ class=md-nav__link> <span class=md-ellipsis> Appendices </span> <span class="md-status md-status--published"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Compliance </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Compliance </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../compliance/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../architecture/roadmap.md class=md-nav__link> <span class=md-ellipsis> Product Roadmap </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-system-overview class=md-nav__link> <span class=md-ellipsis> 1. System Overview </span> </a> </li> <li class=md-nav__item> <a href=#2-presentation-layer-react-18-components class=md-nav__link> <span class=md-ellipsis> 2. Presentation Layer: React 18 Components </span> </a> <nav class=md-nav aria-label="2. Presentation Layer: React 18 Components"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-core-component-architecture class=md-nav__link> <span class=md-ellipsis> 2.1 Core Component Architecture </span> </a> </li> <li class=md-nav__item> <a href=#22-chat-component-with-streaming-responses class=md-nav__link> <span class=md-ellipsis> 2.2 Chat Component with Streaming Responses </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-api-layer-eva-foundation class=md-nav__link> <span class=md-ellipsis> 3. API Layer: EVA Foundation </span> </a> <nav class=md-nav aria-label="3. API Layer: EVA Foundation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-api-gateway-configuration class=md-nav__link> <span class=md-ellipsis> 3.1 API Gateway Configuration </span> </a> </li> <li class=md-nav__item> <a href=#32-chat-endpoint-with-rag-pipeline class=md-nav__link> <span class=md-ellipsis> 3.2 Chat Endpoint with RAG Pipeline </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-data-flow-diagram class=md-nav__link> <span class=md-ellipsis> 4. Data Flow Diagram </span> </a> </li> <li class=md-nav__item> <a href=#5-security-layers class=md-nav__link> <span class=md-ellipsis> 5. Security Layers </span> </a> <nav class=md-nav aria-label="5. Security Layers"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#51-authentication-flow-azure-ad class=md-nav__link> <span class=md-ellipsis> 5.1 Authentication Flow (Azure AD) </span> </a> </li> <li class=md-nav__item> <a href=#52-encryption-cmk-tls class=md-nav__link> <span class=md-ellipsis> 5.2 Encryption (CMK + TLS) </span> </a> </li> <li class=md-nav__item> <a href=#53-role-based-access-control-rbac class=md-nav__link> <span class=md-ellipsis> 5.3 Role-Based Access Control (RBAC) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#6-deployment-topology class=md-nav__link> <span class=md-ellipsis> 6. Deployment Topology </span> </a> </li> <li class=md-nav__item> <a href=#7-summary class=md-nav__link> <span class=md-ellipsis> 7. Summary </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=chapter-02-architecture>Chapter 02: Architecture<a class=headerlink href=#chapter-02-architecture title="Permanent link">&para;</a></h1> <p>EVA Chat 2.0 is a <strong>cloud-native, enterprise-grade conversational AI platform</strong> built on Azure services and governed by the <strong>Government of Canada Agentic AI Framework</strong>. This chapter dissects the technical architecture, from React 18 frontend components to Azure backend services, security layers, and multi-region deployment topology.</p> <h2 id=1-system-overview>1. System Overview<a class=headerlink href=#1-system-overview title="Permanent link">&para;</a></h2> <p>EVA Chat 2.0 follows a <strong>three-tier architecture</strong>:</p> <ol> <li><strong>Presentation Layer</strong> - React 18 UI with EVA Sovereign UI components</li> <li><strong>API Layer</strong> - EVA Foundation API (Node.js/TypeScript) with Azure API Management</li> <li><strong>Data &amp; AI Layer</strong> - Azure OpenAI, Azure AI Search, Cosmos DB, Redis Cache</li> </ol> <pre class=mermaid><code>graph TD
    subgraph "Presentation Layer"
        UI[React 18 UI&lt;br/&gt;EVA Sovereign UI Components]
    end

    subgraph "API Layer - EVA Foundation"
        APIM[Azure API Management&lt;br/&gt;RBAC + Rate Limiting]
        API[EVA Foundation API&lt;br/&gt;Node.js + TypeScript]
    end

    subgraph "Data &amp; AI Layer"
        AOAI[Azure OpenAI&lt;br/&gt;GPT-4 Turbo]
        AIS[Azure AI Search&lt;br/&gt;RAG Pipeline]
        Cosmos[Cosmos DB&lt;br/&gt;Chat History]
        Redis[Redis Cache&lt;br/&gt;Session Store]
        KV[Azure Key Vault&lt;br/&gt;CMK Storage]
    end

    UI --&gt;|HTTPS + Azure AD Token| APIM
    APIM --&gt;|JWT Validation| API
    API --&gt;|Generate Response| AOAI
    API --&gt;|Semantic Search| AIS
    API --&gt;|Store Messages| Cosmos
    API --&gt;|Cache Session| Redis
    API --&gt;|Retrieve CMK| KV

    style UI fill:#e1f5ff
    style API fill:#fff4e1
    style AOAI fill:#ffe1e1
    style AIS fill:#ffe1e1
    style Cosmos fill:#e1ffe1
    style Redis fill:#e1ffe1</code></pre> <p><strong>Design Principles</strong>: - <strong>Separation of Concerns</strong>: UI renders, API orchestrates, AI services process - <strong>Zero-Trust Security</strong>: Every layer validates identity and enforces RBAC - <strong>Fail-Safe Defaults</strong>: All endpoints private, all data encrypted at rest/transit - <strong>Observability-First</strong>: Application Insights telemetry at every boundary</p> <hr> <h2 id=2-presentation-layer-react-18-components>2. Presentation Layer: React 18 Components<a class=headerlink href=#2-presentation-layer-react-18-components title="Permanent link">&para;</a></h2> <p>The frontend leverages <strong>React 18</strong> with <strong>Concurrent Features</strong> (Suspense, Transitions, Streaming SSR) and <strong>EVA Sovereign UI</strong> components for WCAG 2.1 AA compliance and GC Design System branding.</p> <h3 id=21-core-component-architecture>2.1 Core Component Architecture<a class=headerlink href=#21-core-component-architecture title="Permanent link">&para;</a></h3> <div class="language-tsx highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1>// src/App.tsx - Root Application Component</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=k>import</span><span class=w> </span><span class=nx>React</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Suspense</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;react&#39;</span><span class=p>;</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>BrowserRouter</span><span class=p>,</span><span class=w> </span><span class=nx>Routes</span><span class=p>,</span><span class=w> </span><span class=nx>Route</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;react-router-dom&#39;</span><span class=p>;</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>MsalProvider</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@azure/msal-react&#39;</span><span class=p>;</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>msalConfig</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;./config/authConfig&#39;</span><span class=p>;</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PublicClientApplication</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@azure/msal-browser&#39;</span><span class=p>;</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=c1>// EVA Sovereign UI Components</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=k>import</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>  </span><span class=nx>GCHeader</span><span class=p>,</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>  </span><span class=nx>GCFooter</span><span class=p>,</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=w>  </span><span class=nx>AIContentIndicator</span><span class=p>,</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=w>  </span><span class=nx>AIDisclaimer</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@eva/sovereign-ui&#39;</span><span class=p>;</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=c1>// Lazy-loaded route components</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=kd>const</span><span class=w> </span><span class=nx>ChatInterface</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>React</span><span class=p>.</span><span class=nx>lazy</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=k>import</span><span class=p>(</span><span class=s1>&#39;./pages/ChatInterface&#39;</span><span class=p>));</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=kd>const</span><span class=w> </span><span class=nx>HistoryView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>React</span><span class=p>.</span><span class=nx>lazy</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=k>import</span><span class=p>(</span><span class=s1>&#39;./pages/HistoryView&#39;</span><span class=p>));</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=kd>const</span><span class=w> </span><span class=nx>msalInstance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PublicClientApplication</span><span class=p>(</span><span class=nx>msalConfig</span><span class=p>);</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=kd>const</span><span class=w> </span><span class=nx>App</span><span class=o>:</span><span class=w> </span><span class=kt>React.FC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=w>    </span><span class=p>&lt;</span><span class=nt>MsalProvider</span><span class=w> </span><span class=na>instance</span><span class=o>=</span><span class=p>{</span><span class=nx>msalInstance</span><span class=p>}&gt;</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=w>      </span><span class=p>&lt;</span><span class=nt>BrowserRouter</span><span class=p>&gt;</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=w>        </span><span class=p>&lt;</span><span class=nt>GCHeader</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=w>          </span><span class=na>lang</span><span class=o>=</span><span class=s>&quot;en-CA&quot;</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a><span class=w>          </span><span class=na>title</span><span class=o>=</span><span class=s>&quot;EVA Chat 2.0&quot;</span>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a><span class=w>          </span><span class=na>showLanguageToggle</span><span class=o>=</span><span class=p>{</span><span class=kc>true</span><span class=p>}</span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a><span class=w>        </span><span class=p>/&gt;</span>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a><span class=w>        </span><span class=p>&lt;</span><span class=nt>AIDisclaimer</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a><span class=w>          </span><span class=na>autonomyLevel</span><span class=o>=</span><span class=s>&quot;C2&quot;</span>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a><span class=w>          </span><span class=na>message</span><span class=o>=</span><span class=s>&quot;This AI assistant provides information retrieval with human oversight.&quot;</span>
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a><span class=w>        </span><span class=p>/&gt;</span>
</span><span id=__span-0-36><a id=__codelineno-0-36 name=__codelineno-0-36 href=#__codelineno-0-36></a>
</span><span id=__span-0-37><a id=__codelineno-0-37 name=__codelineno-0-37 href=#__codelineno-0-37></a><span class=w>        </span><span class=p>&lt;</span><span class=nt>Suspense</span><span class=w> </span><span class=na>fallback</span><span class=o>=</span><span class=p>{&lt;</span><span class=nt>div</span><span class=p>&gt;</span><span class=nx>Loading</span><span class=p>...&lt;/</span><span class=nt>div</span><span class=p>&gt;}&gt;</span>
</span><span id=__span-0-38><a id=__codelineno-0-38 name=__codelineno-0-38 href=#__codelineno-0-38></a><span class=w>          </span><span class=p>&lt;</span><span class=nt>Routes</span><span class=p>&gt;</span>
</span><span id=__span-0-39><a id=__codelineno-0-39 name=__codelineno-0-39 href=#__codelineno-0-39></a><span class=w>            </span><span class=p>&lt;</span><span class=nt>Route</span><span class=w> </span><span class=na>path</span><span class=o>=</span><span class=s>&quot;/&quot;</span><span class=w> </span><span class=na>element</span><span class=o>=</span><span class=p>{&lt;</span><span class=nt>ChatInterface</span><span class=w> </span><span class=p>/&gt;}</span><span class=w> </span><span class=p>/&gt;</span>
</span><span id=__span-0-40><a id=__codelineno-0-40 name=__codelineno-0-40 href=#__codelineno-0-40></a><span class=w>            </span><span class=p>&lt;</span><span class=nt>Route</span><span class=w> </span><span class=na>path</span><span class=o>=</span><span class=s>&quot;/history&quot;</span><span class=w> </span><span class=na>element</span><span class=o>=</span><span class=p>{&lt;</span><span class=nt>HistoryView</span><span class=w> </span><span class=p>/&gt;}</span><span class=w> </span><span class=p>/&gt;</span>
</span><span id=__span-0-41><a id=__codelineno-0-41 name=__codelineno-0-41 href=#__codelineno-0-41></a><span class=w>          </span><span class=p>&lt;/</span><span class=nt>Routes</span><span class=p>&gt;</span>
</span><span id=__span-0-42><a id=__codelineno-0-42 name=__codelineno-0-42 href=#__codelineno-0-42></a><span class=w>        </span><span class=p>&lt;/</span><span class=nt>Suspense</span><span class=p>&gt;</span>
</span><span id=__span-0-43><a id=__codelineno-0-43 name=__codelineno-0-43 href=#__codelineno-0-43></a>
</span><span id=__span-0-44><a id=__codelineno-0-44 name=__codelineno-0-44 href=#__codelineno-0-44></a><span class=w>        </span><span class=p>&lt;</span><span class=nt>GCFooter</span><span class=w> </span><span class=p>/&gt;</span>
</span><span id=__span-0-45><a id=__codelineno-0-45 name=__codelineno-0-45 href=#__codelineno-0-45></a><span class=w>      </span><span class=p>&lt;/</span><span class=nt>BrowserRouter</span><span class=p>&gt;</span>
</span><span id=__span-0-46><a id=__codelineno-0-46 name=__codelineno-0-46 href=#__codelineno-0-46></a><span class=w>    </span><span class=p>&lt;/</span><span class=nt>MsalProvider</span><span class=p>&gt;</span>
</span><span id=__span-0-47><a id=__codelineno-0-47 name=__codelineno-0-47 href=#__codelineno-0-47></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-0-48><a id=__codelineno-0-48 name=__codelineno-0-48 href=#__codelineno-0-48></a><span class=p>};</span>
</span><span id=__span-0-49><a id=__codelineno-0-49 name=__codelineno-0-49 href=#__codelineno-0-49></a>
</span><span id=__span-0-50><a id=__codelineno-0-50 name=__codelineno-0-50 href=#__codelineno-0-50></a><span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=nx>App</span><span class=p>;</span>
</span></code></pre></div> <h3 id=22-chat-component-with-streaming-responses>2.2 Chat Component with Streaming Responses<a class=headerlink href=#22-chat-component-with-streaming-responses title="Permanent link">&para;</a></h3> <div class="language-tsx highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1>// src/components/ChatWindow.tsx</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=k>import</span><span class=w> </span><span class=nx>React</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>useState</span><span class=p>,</span><span class=w> </span><span class=nx>useRef</span><span class=p>,</span><span class=w> </span><span class=nx>useEffect</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;react&#39;</span><span class=p>;</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>useMsal</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@azure/msal-react&#39;</span><span class=p>;</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>ChatMessage</span><span class=p>,</span><span class=w> </span><span class=nx>CitationCard</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@eva/sovereign-ui&#39;</span><span class=p>;</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>streamChatResponse</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../api/chatApi&#39;</span><span class=p>;</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=kd>interface</span><span class=w> </span><span class=nx>Message</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>  </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>  </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=s1>&#39;assistant&#39;</span><span class=p>;</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>  </span><span class=nx>content</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=w>  </span><span class=nx>citations?</span><span class=o>:</span><span class=w> </span><span class=kt>Citation</span><span class=p>[];</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=w>  </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>Date</span><span class=p>;</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=p>}</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=kd>const</span><span class=w> </span><span class=nx>ChatWindow</span><span class=o>:</span><span class=w> </span><span class=kt>React.FC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>instance</span><span class=p>,</span><span class=w> </span><span class=nx>accounts</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useMsal</span><span class=p>();</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>messages</span><span class=p>,</span><span class=w> </span><span class=nx>setMessages</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useState</span><span class=p>&lt;</span><span class=nt>Message</span><span class=err>[]</span><span class=p>&gt;([]);</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>input</span><span class=p>,</span><span class=w> </span><span class=nx>setInput</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useState</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>);</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>isStreaming</span><span class=p>,</span><span class=w> </span><span class=nx>setIsStreaming</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useState</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>messagesEndRef</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useRef</span><span class=p>&lt;</span><span class=nt>HTMLDivElement</span><span class=p>&gt;(</span><span class=kc>null</span><span class=p>);</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>sendMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>input</span><span class=p>.</span><span class=nx>trim</span><span class=p>())</span><span class=w> </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a>
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>userMessage</span><span class=o>:</span><span class=w> </span><span class=kt>Message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-26><a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>crypto.randomUUID</span><span class=p>(),</span>
</span><span id=__span-1-27><a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a><span class=w>      </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=p>,</span>
</span><span id=__span-1-28><a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a><span class=w>      </span><span class=nx>content</span><span class=o>:</span><span class=w> </span><span class=kt>input</span><span class=p>,</span>
</span><span id=__span-1-29><a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a><span class=w>      </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>()</span>
</span><span id=__span-1-30><a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-1-31><a id=__codelineno-1-31 name=__codelineno-1-31 href=#__codelineno-1-31></a>
</span><span id=__span-1-32><a id=__codelineno-1-32 name=__codelineno-1-32 href=#__codelineno-1-32></a><span class=w>    </span><span class=nx>setMessages</span><span class=p>(</span><span class=nx>prev</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>[...</span><span class=nx>prev</span><span class=p>,</span><span class=w> </span><span class=nx>userMessage</span><span class=p>]);</span>
</span><span id=__span-1-33><a id=__codelineno-1-33 name=__codelineno-1-33 href=#__codelineno-1-33></a><span class=w>    </span><span class=nx>setInput</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>);</span>
</span><span id=__span-1-34><a id=__codelineno-1-34 name=__codelineno-1-34 href=#__codelineno-1-34></a><span class=w>    </span><span class=nx>setIsStreaming</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-1-35><a id=__codelineno-1-35 name=__codelineno-1-35 href=#__codelineno-1-35></a>
</span><span id=__span-1-36><a id=__codelineno-1-36 name=__codelineno-1-36 href=#__codelineno-1-36></a><span class=w>    </span><span class=c1>// Get Azure AD token</span>
</span><span id=__span-1-37><a id=__codelineno-1-37 name=__codelineno-1-37 href=#__codelineno-1-37></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>instance</span><span class=p>.</span><span class=nx>acquireTokenSilent</span><span class=p>({</span>
</span><span id=__span-1-38><a id=__codelineno-1-38 name=__codelineno-1-38 href=#__codelineno-1-38></a><span class=w>      </span><span class=nx>scopes</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;api://eva-foundation/.default&#39;</span><span class=p>],</span>
</span><span id=__span-1-39><a id=__codelineno-1-39 name=__codelineno-1-39 href=#__codelineno-1-39></a><span class=w>      </span><span class=nx>account</span><span class=o>:</span><span class=w> </span><span class=kt>accounts</span><span class=p>[</span><span class=mf>0</span><span class=p>]</span>
</span><span id=__span-1-40><a id=__codelineno-1-40 name=__codelineno-1-40 href=#__codelineno-1-40></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-1-41><a id=__codelineno-1-41 name=__codelineno-1-41 href=#__codelineno-1-41></a>
</span><span id=__span-1-42><a id=__codelineno-1-42 name=__codelineno-1-42 href=#__codelineno-1-42></a><span class=w>    </span><span class=c1>// Stream response from EVA Foundation API</span>
</span><span id=__span-1-43><a id=__codelineno-1-43 name=__codelineno-1-43 href=#__codelineno-1-43></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>assistantMessage</span><span class=o>:</span><span class=w> </span><span class=kt>Message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-44><a id=__codelineno-1-44 name=__codelineno-1-44 href=#__codelineno-1-44></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>crypto.randomUUID</span><span class=p>(),</span>
</span><span id=__span-1-45><a id=__codelineno-1-45 name=__codelineno-1-45 href=#__codelineno-1-45></a><span class=w>      </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;assistant&#39;</span><span class=p>,</span>
</span><span id=__span-1-46><a id=__codelineno-1-46 name=__codelineno-1-46 href=#__codelineno-1-46></a><span class=w>      </span><span class=nx>content</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>,</span>
</span><span id=__span-1-47><a id=__codelineno-1-47 name=__codelineno-1-47 href=#__codelineno-1-47></a><span class=w>      </span><span class=nx>citations</span><span class=o>:</span><span class=w> </span><span class=p>[],</span>
</span><span id=__span-1-48><a id=__codelineno-1-48 name=__codelineno-1-48 href=#__codelineno-1-48></a><span class=w>      </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>()</span>
</span><span id=__span-1-49><a id=__codelineno-1-49 name=__codelineno-1-49 href=#__codelineno-1-49></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-1-50><a id=__codelineno-1-50 name=__codelineno-1-50 href=#__codelineno-1-50></a>
</span><span id=__span-1-51><a id=__codelineno-1-51 name=__codelineno-1-51 href=#__codelineno-1-51></a><span class=w>    </span><span class=nx>setMessages</span><span class=p>(</span><span class=nx>prev</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>[...</span><span class=nx>prev</span><span class=p>,</span><span class=w> </span><span class=nx>assistantMessage</span><span class=p>]);</span>
</span><span id=__span-1-52><a id=__codelineno-1-52 name=__codelineno-1-52 href=#__codelineno-1-52></a>
</span><span id=__span-1-53><a id=__codelineno-1-53 name=__codelineno-1-53 href=#__codelineno-1-53></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>streamChatResponse</span><span class=p>(</span>
</span><span id=__span-1-54><a id=__codelineno-1-54 name=__codelineno-1-54 href=#__codelineno-1-54></a><span class=w>      </span><span class=nx>input</span><span class=p>,</span>
</span><span id=__span-1-55><a id=__codelineno-1-55 name=__codelineno-1-55 href=#__codelineno-1-55></a><span class=w>      </span><span class=nx>token</span><span class=p>.</span><span class=nx>accessToken</span><span class=p>,</span>
</span><span id=__span-1-56><a id=__codelineno-1-56 name=__codelineno-1-56 href=#__codelineno-1-56></a><span class=w>      </span><span class=p>(</span><span class=nx>chunk</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-57><a id=__codelineno-1-57 name=__codelineno-1-57 href=#__codelineno-1-57></a><span class=w>        </span><span class=c1>// Update message content as chunks arrive</span>
</span><span id=__span-1-58><a id=__codelineno-1-58 name=__codelineno-1-58 href=#__codelineno-1-58></a><span class=w>        </span><span class=nx>setMessages</span><span class=p>(</span><span class=nx>prev</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-59><a id=__codelineno-1-59 name=__codelineno-1-59 href=#__codelineno-1-59></a><span class=w>          </span><span class=kd>const</span><span class=w> </span><span class=nx>updated</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[...</span><span class=nx>prev</span><span class=p>];</span>
</span><span id=__span-1-60><a id=__codelineno-1-60 name=__codelineno-1-60 href=#__codelineno-1-60></a><span class=w>          </span><span class=nx>updated</span><span class=p>[</span><span class=nx>updated</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mf>1</span><span class=p>].</span><span class=nx>content</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>chunk</span><span class=p>.</span><span class=nx>text</span><span class=p>;</span>
</span><span id=__span-1-61><a id=__codelineno-1-61 name=__codelineno-1-61 href=#__codelineno-1-61></a><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>chunk</span><span class=p>.</span><span class=nx>citations</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-62><a id=__codelineno-1-62 name=__codelineno-1-62 href=#__codelineno-1-62></a><span class=w>            </span><span class=nx>updated</span><span class=p>[</span><span class=nx>updated</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mf>1</span><span class=p>].</span><span class=nx>citations</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>chunk</span><span class=p>.</span><span class=nx>citations</span><span class=p>;</span>
</span><span id=__span-1-63><a id=__codelineno-1-63 name=__codelineno-1-63 href=#__codelineno-1-63></a><span class=w>          </span><span class=p>}</span>
</span><span id=__span-1-64><a id=__codelineno-1-64 name=__codelineno-1-64 href=#__codelineno-1-64></a><span class=w>          </span><span class=k>return</span><span class=w> </span><span class=nx>updated</span><span class=p>;</span>
</span><span id=__span-1-65><a id=__codelineno-1-65 name=__codelineno-1-65 href=#__codelineno-1-65></a><span class=w>        </span><span class=p>});</span>
</span><span id=__span-1-66><a id=__codelineno-1-66 name=__codelineno-1-66 href=#__codelineno-1-66></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-1-67><a id=__codelineno-1-67 name=__codelineno-1-67 href=#__codelineno-1-67></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-1-68><a id=__codelineno-1-68 name=__codelineno-1-68 href=#__codelineno-1-68></a>
</span><span id=__span-1-69><a id=__codelineno-1-69 name=__codelineno-1-69 href=#__codelineno-1-69></a><span class=w>    </span><span class=nx>setIsStreaming</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-1-70><a id=__codelineno-1-70 name=__codelineno-1-70 href=#__codelineno-1-70></a><span class=w>  </span><span class=p>};</span>
</span><span id=__span-1-71><a id=__codelineno-1-71 name=__codelineno-1-71 href=#__codelineno-1-71></a>
</span><span id=__span-1-72><a id=__codelineno-1-72 name=__codelineno-1-72 href=#__codelineno-1-72></a><span class=w>  </span><span class=nx>useEffect</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-73><a id=__codelineno-1-73 name=__codelineno-1-73 href=#__codelineno-1-73></a><span class=w>    </span><span class=nx>messagesEndRef</span><span class=p>.</span><span class=nx>current</span><span class=o>?</span><span class=p>.</span><span class=nx>scrollIntoView</span><span class=p>({</span><span class=w> </span><span class=nx>behavior</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;smooth&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-1-74><a id=__codelineno-1-74 name=__codelineno-1-74 href=#__codelineno-1-74></a><span class=w>  </span><span class=p>},</span><span class=w> </span><span class=p>[</span><span class=nx>messages</span><span class=p>]);</span>
</span><span id=__span-1-75><a id=__codelineno-1-75 name=__codelineno-1-75 href=#__codelineno-1-75></a>
</span><span id=__span-1-76><a id=__codelineno-1-76 name=__codelineno-1-76 href=#__codelineno-1-76></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-1-77><a id=__codelineno-1-77 name=__codelineno-1-77 href=#__codelineno-1-77></a><span class=w>    </span><span class=p>&lt;</span><span class=nt>div</span><span class=w> </span><span class=na>className</span><span class=o>=</span><span class=s>&quot;chat-window&quot;</span><span class=p>&gt;</span>
</span><span id=__span-1-78><a id=__codelineno-1-78 name=__codelineno-1-78 href=#__codelineno-1-78></a><span class=w>      </span><span class=p>&lt;</span><span class=nt>div</span><span class=w> </span><span class=na>className</span><span class=o>=</span><span class=s>&quot;messages-container&quot;</span><span class=p>&gt;</span>
</span><span id=__span-1-79><a id=__codelineno-1-79 name=__codelineno-1-79 href=#__codelineno-1-79></a><span class=w>        </span><span class=p>{</span><span class=nx>messages</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>msg</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-1-80><a id=__codelineno-1-80 name=__codelineno-1-80 href=#__codelineno-1-80></a><span class=w>          </span><span class=p>&lt;</span><span class=nt>ChatMessage</span>
</span><span id=__span-1-81><a id=__codelineno-1-81 name=__codelineno-1-81 href=#__codelineno-1-81></a><span class=w>            </span><span class=na>key</span><span class=o>=</span><span class=p>{</span><span class=nx>msg</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span>
</span><span id=__span-1-82><a id=__codelineno-1-82 name=__codelineno-1-82 href=#__codelineno-1-82></a><span class=w>            </span><span class=na>role</span><span class=o>=</span><span class=p>{</span><span class=nx>msg</span><span class=p>.</span><span class=nx>role</span><span class=p>}</span>
</span><span id=__span-1-83><a id=__codelineno-1-83 name=__codelineno-1-83 href=#__codelineno-1-83></a><span class=w>            </span><span class=na>content</span><span class=o>=</span><span class=p>{</span><span class=nx>msg</span><span class=p>.</span><span class=nx>content</span><span class=p>}</span>
</span><span id=__span-1-84><a id=__codelineno-1-84 name=__codelineno-1-84 href=#__codelineno-1-84></a><span class=w>            </span><span class=na>timestamp</span><span class=o>=</span><span class=p>{</span><span class=nx>msg</span><span class=p>.</span><span class=nx>timestamp</span><span class=p>}</span>
</span><span id=__span-1-85><a id=__codelineno-1-85 name=__codelineno-1-85 href=#__codelineno-1-85></a><span class=w>            </span><span class=na>citations</span><span class=o>=</span><span class=p>{</span><span class=nx>msg</span><span class=p>.</span><span class=nx>citations</span><span class=p>}</span>
</span><span id=__span-1-86><a id=__codelineno-1-86 name=__codelineno-1-86 href=#__codelineno-1-86></a><span class=w>            </span><span class=na>showAIIndicator</span><span class=o>=</span><span class=p>{</span><span class=nx>msg</span><span class=p>.</span><span class=nx>role</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;assistant&#39;</span><span class=p>}</span>
</span><span id=__span-1-87><a id=__codelineno-1-87 name=__codelineno-1-87 href=#__codelineno-1-87></a><span class=w>          </span><span class=p>/&gt;</span>
</span><span id=__span-1-88><a id=__codelineno-1-88 name=__codelineno-1-88 href=#__codelineno-1-88></a><span class=w>        </span><span class=p>))}</span>
</span><span id=__span-1-89><a id=__codelineno-1-89 name=__codelineno-1-89 href=#__codelineno-1-89></a><span class=w>        </span><span class=p>&lt;</span><span class=nt>div</span><span class=w> </span><span class=na>ref</span><span class=o>=</span><span class=p>{</span><span class=nx>messagesEndRef</span><span class=p>}</span><span class=w> </span><span class=p>/&gt;</span>
</span><span id=__span-1-90><a id=__codelineno-1-90 name=__codelineno-1-90 href=#__codelineno-1-90></a><span class=w>      </span><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span><span id=__span-1-91><a id=__codelineno-1-91 name=__codelineno-1-91 href=#__codelineno-1-91></a>
</span><span id=__span-1-92><a id=__codelineno-1-92 name=__codelineno-1-92 href=#__codelineno-1-92></a><span class=w>      </span><span class=p>&lt;</span><span class=nt>div</span><span class=w> </span><span class=na>className</span><span class=o>=</span><span class=s>&quot;input-container&quot;</span><span class=p>&gt;</span>
</span><span id=__span-1-93><a id=__codelineno-1-93 name=__codelineno-1-93 href=#__codelineno-1-93></a><span class=w>        </span><span class=p>&lt;</span><span class=nt>textarea</span>
</span><span id=__span-1-94><a id=__codelineno-1-94 name=__codelineno-1-94 href=#__codelineno-1-94></a><span class=w>          </span><span class=na>value</span><span class=o>=</span><span class=p>{</span><span class=nx>input</span><span class=p>}</span>
</span><span id=__span-1-95><a id=__codelineno-1-95 name=__codelineno-1-95 href=#__codelineno-1-95></a><span class=w>          </span><span class=na>onChange</span><span class=o>=</span><span class=p>{</span><span class=nx>e</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>setInput</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>value</span><span class=p>)}</span>
</span><span id=__span-1-96><a id=__codelineno-1-96 name=__codelineno-1-96 href=#__codelineno-1-96></a><span class=w>          </span><span class=na>onKeyDown</span><span class=o>=</span><span class=p>{</span><span class=nx>e</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>e</span><span class=p>.</span><span class=nx>key</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;Enter&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=nx>e</span><span class=p>.</span><span class=nx>shiftKey</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>sendMessage</span><span class=p>()}</span>
</span><span id=__span-1-97><a id=__codelineno-1-97 name=__codelineno-1-97 href=#__codelineno-1-97></a><span class=w>          </span><span class=na>placeholder</span><span class=o>=</span><span class=s>&quot;Ask a question...&quot;</span>
</span><span id=__span-1-98><a id=__codelineno-1-98 name=__codelineno-1-98 href=#__codelineno-1-98></a><span class=w>          </span><span class=na>disabled</span><span class=o>=</span><span class=p>{</span><span class=nx>isStreaming</span><span class=p>}</span>
</span><span id=__span-1-99><a id=__codelineno-1-99 name=__codelineno-1-99 href=#__codelineno-1-99></a><span class=w>          </span><span class=na>aria-label</span><span class=o>=</span><span class=s>&quot;Chat input&quot;</span>
</span><span id=__span-1-100><a id=__codelineno-1-100 name=__codelineno-1-100 href=#__codelineno-1-100></a><span class=w>        </span><span class=p>/&gt;</span>
</span><span id=__span-1-101><a id=__codelineno-1-101 name=__codelineno-1-101 href=#__codelineno-1-101></a><span class=w>        </span><span class=p>&lt;</span><span class=nt>button</span><span class=w> </span><span class=na>onClick</span><span class=o>=</span><span class=p>{</span><span class=nx>sendMessage</span><span class=p>}</span><span class=w> </span><span class=na>disabled</span><span class=o>=</span><span class=p>{</span><span class=nx>isStreaming</span><span class=p>}&gt;</span>
</span><span id=__span-1-102><a id=__codelineno-1-102 name=__codelineno-1-102 href=#__codelineno-1-102></a><span class=w>          </span><span class=p>{</span><span class=nx>isStreaming</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s1>&#39;Thinking...&#39;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Send&#39;</span><span class=p>}</span>
</span><span id=__span-1-103><a id=__codelineno-1-103 name=__codelineno-1-103 href=#__codelineno-1-103></a><span class=w>        </span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span><span id=__span-1-104><a id=__codelineno-1-104 name=__codelineno-1-104 href=#__codelineno-1-104></a><span class=w>      </span><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span><span id=__span-1-105><a id=__codelineno-1-105 name=__codelineno-1-105 href=#__codelineno-1-105></a><span class=w>    </span><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span><span id=__span-1-106><a id=__codelineno-1-106 name=__codelineno-1-106 href=#__codelineno-1-106></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-1-107><a id=__codelineno-1-107 name=__codelineno-1-107 href=#__codelineno-1-107></a><span class=p>};</span>
</span><span id=__span-1-108><a id=__codelineno-1-108 name=__codelineno-1-108 href=#__codelineno-1-108></a>
</span><span id=__span-1-109><a id=__codelineno-1-109 name=__codelineno-1-109 href=#__codelineno-1-109></a><span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=nx>ChatWindow</span><span class=p>;</span>
</span></code></pre></div> <p><strong>Key Features</strong>: - <strong>Concurrent Rendering</strong>: React 18 Transitions for non-blocking UI updates - <strong>Streaming Responses</strong>: Real-time token-by-token rendering (SSE/WebSockets) - <strong>WCAG 2.1 AA</strong>: Keyboard navigation, ARIA labels, screen reader support - <strong>GC Branding</strong>: <code>GCHeader</code>, <code>GCFooter</code>, bilingual labels (en-CA/fr-CA)</p> <hr> <h2 id=3-api-layer-eva-foundation>3. API Layer: EVA Foundation<a class=headerlink href=#3-api-layer-eva-foundation title="Permanent link">&para;</a></h2> <p>EVA Foundation is a <strong>Node.js/TypeScript API</strong> that orchestrates AI services, enforces RBAC, and manages chat sessions. Deployed behind <strong>Azure API Management</strong> for rate limiting, throttling, and JWT validation.</p> <h3 id=31-api-gateway-configuration>3.1 API Gateway Configuration<a class=headerlink href=#31-api-gateway-configuration title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1>// src/config/apim.ts - APIM Policy Configuration</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>apimPolicies</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>  </span><span class=nx>inbound</span><span class=o>:</span><span class=w> </span><span class=sb>`</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=sb>    &lt;policies&gt;</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=sb>      &lt;inbound&gt;</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=sb>        &lt;!-- Validate Azure AD JWT --&gt;</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=sb>        &lt;validate-jwt header-name=&quot;Authorization&quot;</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=sb>                       failed-validation-httpcode=&quot;401&quot;&gt;</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=sb>          &lt;openid-config url=&quot;https://login.microsoftonline.com/{tenant}/.well-known/openid-configuration&quot; /&gt;</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=sb>          &lt;audiences&gt;</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=sb>            &lt;audience&gt;api://eva-foundation&lt;/audience&gt;</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=sb>          &lt;/audiences&gt;</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=sb>        &lt;/validate-jwt&gt;</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=sb>        &lt;!-- Rate Limiting: 100 requests/min per user --&gt;</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=sb>        &lt;rate-limit-by-key calls=&quot;100&quot;</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=sb>                           renewal-period=&quot;60&quot;</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=sb>                           counter-key=&quot;@(context.Request.Headers.GetValueOrDefault(&#39;Authorization&#39;))&quot; /&gt;</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=sb>        &lt;!-- CORS for Sovereign UI --&gt;</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=sb>        &lt;cors allow-credentials=&quot;true&quot;&gt;</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=sb>          &lt;allowed-origins&gt;</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=sb>            &lt;origin&gt;https://eva-chat.canada.ca&lt;/origin&gt;</span>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a><span class=sb>          &lt;/allowed-origins&gt;</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a><span class=sb>          &lt;allowed-methods&gt;</span>
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a><span class=sb>            &lt;method&gt;GET&lt;/method&gt;</span>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a><span class=sb>            &lt;method&gt;POST&lt;/method&gt;</span>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a><span class=sb>          &lt;/allowed-methods&gt;</span>
</span><span id=__span-2-29><a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a><span class=sb>        &lt;/cors&gt;</span>
</span><span id=__span-2-30><a id=__codelineno-2-30 name=__codelineno-2-30 href=#__codelineno-2-30></a>
</span><span id=__span-2-31><a id=__codelineno-2-31 name=__codelineno-2-31 href=#__codelineno-2-31></a><span class=sb>        &lt;!-- Forward to backend API --&gt;</span>
</span><span id=__span-2-32><a id=__codelineno-2-32 name=__codelineno-2-32 href=#__codelineno-2-32></a><span class=sb>        &lt;set-backend-service base-url=&quot;https://eva-foundation-api.azurewebsites.net&quot; /&gt;</span>
</span><span id=__span-2-33><a id=__codelineno-2-33 name=__codelineno-2-33 href=#__codelineno-2-33></a><span class=sb>      &lt;/inbound&gt;</span>
</span><span id=__span-2-34><a id=__codelineno-2-34 name=__codelineno-2-34 href=#__codelineno-2-34></a><span class=sb>    &lt;/policies&gt;</span>
</span><span id=__span-2-35><a id=__codelineno-2-35 name=__codelineno-2-35 href=#__codelineno-2-35></a><span class=sb>  `</span>
</span><span id=__span-2-36><a id=__codelineno-2-36 name=__codelineno-2-36 href=#__codelineno-2-36></a><span class=p>};</span>
</span></code></pre></div> <h3 id=32-chat-endpoint-with-rag-pipeline>3.2 Chat Endpoint with RAG Pipeline<a class=headerlink href=#32-chat-endpoint-with-rag-pipeline title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1>// src/routes/chat.ts</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=k>import</span><span class=w> </span><span class=nx>express</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>OpenAIClient</span><span class=p>,</span><span class=w> </span><span class=nx>AzureKeyCredential</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@azure/openai&#39;</span><span class=p>;</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>SearchClient</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@azure/search-documents&#39;</span><span class=p>;</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>CosmosClient</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@azure/cosmos&#39;</span><span class=p>;</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>verifyRBAC</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../middleware/auth&#39;</span><span class=p>;</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=kd>const</span><span class=w> </span><span class=nx>router</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=c1>// Azure SDK Clients</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=kd>const</span><span class=w> </span><span class=nx>openaiClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>OpenAIClient</span><span class=p>(</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>  </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>AZURE_OPENAI_ENDPOINT</span><span class=o>!</span><span class=p>,</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>  </span><span class=ow>new</span><span class=w> </span><span class=nx>AzureKeyCredential</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>AZURE_OPENAI_KEY</span><span class=o>!</span><span class=p>)</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=p>);</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=kd>const</span><span class=w> </span><span class=nx>searchClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>SearchClient</span><span class=p>(</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>  </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>AZURE_SEARCH_ENDPOINT</span><span class=o>!</span><span class=p>,</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>  </span><span class=s1>&#39;jurisprudence-index&#39;</span><span class=p>,</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>  </span><span class=ow>new</span><span class=w> </span><span class=nx>AzureKeyCredential</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>AZURE_SEARCH_KEY</span><span class=o>!</span><span class=p>)</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=p>);</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=kd>const</span><span class=w> </span><span class=nx>cosmosClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>CosmosClient</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>COSMOS_CONNECTION_STRING</span><span class=o>!</span><span class=p>);</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=kd>const</span><span class=w> </span><span class=nx>chatContainer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>cosmosClient</span><span class=p>.</span><span class=nx>database</span><span class=p>(</span><span class=s1>&#39;eva-chat&#39;</span><span class=p>).</span><span class=nx>container</span><span class=p>(</span><span class=s1>&#39;conversations&#39;</span><span class=p>);</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/chat/completions&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>verifyRBAC</span><span class=p>([</span><span class=s1>&#39;chat.user&#39;</span><span class=p>]),</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>message</span><span class=p>,</span><span class=w> </span><span class=nx>conversationId</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>;</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=o>!</span><span class=p>.</span><span class=nx>oid</span><span class=p>;</span><span class=w> </span><span class=c1>// Azure AD object ID</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a><span class=w>    </span><span class=c1>// Step 1: Semantic Search (RAG Retrieval)</span>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>searchResults</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>searchClient</span><span class=p>.</span><span class=nx>search</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a><span class=w>      </span><span class=nx>top</span><span class=o>:</span><span class=w> </span><span class=kt>5</span><span class=p>,</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a><span class=w>      </span><span class=nx>select</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;title&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;url&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;chunk_id&#39;</span><span class=p>],</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a><span class=w>      </span><span class=nx>queryType</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;semantic&#39;</span><span class=p>,</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a><span class=w>      </span><span class=nx>semanticConfiguration</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;default&#39;</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[];</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=nx>searchResults</span><span class=p>.</span><span class=nx>results</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a><span class=w>      </span><span class=nx>context</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a><span class=w>        </span><span class=nx>content</span><span class=o>:</span><span class=w> </span><span class=kt>result.document.content</span><span class=p>,</span>
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a><span class=w>        </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=kt>result.document.title</span><span class=p>,</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a><span class=w>        </span><span class=nx>url</span><span class=o>:</span><span class=w> </span><span class=kt>result.document.url</span><span class=p>,</span>
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44 href=#__codelineno-3-44></a><span class=w>        </span><span class=nx>score</span><span class=o>:</span><span class=w> </span><span class=kt>result.score</span>
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45 href=#__codelineno-3-45></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46 href=#__codelineno-3-46></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47 href=#__codelineno-3-47></a>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48 href=#__codelineno-3-48></a><span class=w>    </span><span class=c1>// Step 2: Build GPT-4 Prompt with RAG Context</span>
</span><span id=__span-3-49><a id=__codelineno-3-49 name=__codelineno-3-49 href=#__codelineno-3-49></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>systemPrompt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`You are EVA Chat Assistant. Use the following context to answer the user&#39;s question. Always cite sources.</span>
</span><span id=__span-3-50><a id=__codelineno-3-50 name=__codelineno-3-50 href=#__codelineno-3-50></a>
</span><span id=__span-3-51><a id=__codelineno-3-51 name=__codelineno-3-51 href=#__codelineno-3-51></a><span class=sb>Context:</span>
</span><span id=__span-3-52><a id=__codelineno-3-52 name=__codelineno-3-52 href=#__codelineno-3-52></a><span class=si>${</span><span class=nx>context</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>i</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=sb>`[</span><span class=si>${</span><span class=nx>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mf>1</span><span class=si>}</span><span class=sb>] </span><span class=si>${</span><span class=nx>c</span><span class=p>.</span><span class=nx>title</span><span class=si>}</span><span class=sb>: </span><span class=si>${</span><span class=nx>c</span><span class=p>.</span><span class=nx>content</span><span class=si>}</span><span class=sb>`</span><span class=p>).</span><span class=nx>join</span><span class=p>(</span><span class=s1>&#39;\n\n&#39;</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span><span id=__span-3-53><a id=__codelineno-3-53 name=__codelineno-3-53 href=#__codelineno-3-53></a>
</span><span id=__span-3-54><a id=__codelineno-3-54 name=__codelineno-3-54 href=#__codelineno-3-54></a><span class=w>    </span><span class=c1>// Step 3: Call Azure OpenAI GPT-4</span>
</span><span id=__span-3-55><a id=__codelineno-3-55 name=__codelineno-3-55 href=#__codelineno-3-55></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>completion</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>openaiClient</span><span class=p>.</span><span class=nx>getChatCompletions</span><span class=p>(</span>
</span><span id=__span-3-56><a id=__codelineno-3-56 name=__codelineno-3-56 href=#__codelineno-3-56></a><span class=w>      </span><span class=s1>&#39;gpt-4-turbo&#39;</span><span class=p>,</span>
</span><span id=__span-3-57><a id=__codelineno-3-57 name=__codelineno-3-57 href=#__codelineno-3-57></a><span class=w>      </span><span class=p>[</span>
</span><span id=__span-3-58><a id=__codelineno-3-58 name=__codelineno-3-58 href=#__codelineno-3-58></a><span class=w>        </span><span class=p>{</span><span class=w> </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;system&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>content</span><span class=o>:</span><span class=w> </span><span class=kt>systemPrompt</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-3-59><a id=__codelineno-3-59 name=__codelineno-3-59 href=#__codelineno-3-59></a><span class=w>        </span><span class=p>{</span><span class=w> </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>content</span><span class=o>:</span><span class=w> </span><span class=kt>message</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-3-60><a id=__codelineno-3-60 name=__codelineno-3-60 href=#__codelineno-3-60></a><span class=w>      </span><span class=p>],</span>
</span><span id=__span-3-61><a id=__codelineno-3-61 name=__codelineno-3-61 href=#__codelineno-3-61></a><span class=w>      </span><span class=p>{</span>
</span><span id=__span-3-62><a id=__codelineno-3-62 name=__codelineno-3-62 href=#__codelineno-3-62></a><span class=w>        </span><span class=nx>temperature</span><span class=o>:</span><span class=w> </span><span class=kt>0.7</span><span class=p>,</span>
</span><span id=__span-3-63><a id=__codelineno-3-63 name=__codelineno-3-63 href=#__codelineno-3-63></a><span class=w>        </span><span class=nx>maxTokens</span><span class=o>:</span><span class=w> </span><span class=kt>800</span><span class=p>,</span>
</span><span id=__span-3-64><a id=__codelineno-3-64 name=__codelineno-3-64 href=#__codelineno-3-64></a><span class=w>        </span><span class=nx>topP</span><span class=o>:</span><span class=w> </span><span class=kt>0.95</span>
</span><span id=__span-3-65><a id=__codelineno-3-65 name=__codelineno-3-65 href=#__codelineno-3-65></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-3-66><a id=__codelineno-3-66 name=__codelineno-3-66 href=#__codelineno-3-66></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-3-67><a id=__codelineno-3-67 name=__codelineno-3-67 href=#__codelineno-3-67></a>
</span><span id=__span-3-68><a id=__codelineno-3-68 name=__codelineno-3-68 href=#__codelineno-3-68></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>assistantReply</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>completion</span><span class=p>.</span><span class=nx>choices</span><span class=p>[</span><span class=mf>0</span><span class=p>].</span><span class=nx>message</span><span class=o>?</span><span class=p>.</span><span class=nx>content</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>;</span>
</span><span id=__span-3-69><a id=__codelineno-3-69 name=__codelineno-3-69 href=#__codelineno-3-69></a>
</span><span id=__span-3-70><a id=__codelineno-3-70 name=__codelineno-3-70 href=#__codelineno-3-70></a><span class=w>    </span><span class=c1>// Step 4: Store in Cosmos DB</span>
</span><span id=__span-3-71><a id=__codelineno-3-71 name=__codelineno-3-71 href=#__codelineno-3-71></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>chatContainer</span><span class=p>.</span><span class=nx>items</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span><span id=__span-3-72><a id=__codelineno-3-72 name=__codelineno-3-72 href=#__codelineno-3-72></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>crypto.randomUUID</span><span class=p>(),</span>
</span><span id=__span-3-73><a id=__codelineno-3-73 name=__codelineno-3-73 href=#__codelineno-3-73></a><span class=w>      </span><span class=nx>conversationId</span><span class=p>,</span>
</span><span id=__span-3-74><a id=__codelineno-3-74 name=__codelineno-3-74 href=#__codelineno-3-74></a><span class=w>      </span><span class=nx>userId</span><span class=p>,</span>
</span><span id=__span-3-75><a id=__codelineno-3-75 name=__codelineno-3-75 href=#__codelineno-3-75></a><span class=w>      </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>(),</span>
</span><span id=__span-3-76><a id=__codelineno-3-76 name=__codelineno-3-76 href=#__codelineno-3-76></a><span class=w>      </span><span class=nx>userMessage</span><span class=o>:</span><span class=w> </span><span class=kt>message</span><span class=p>,</span>
</span><span id=__span-3-77><a id=__codelineno-3-77 name=__codelineno-3-77 href=#__codelineno-3-77></a><span class=w>      </span><span class=nx>assistantReply</span><span class=p>,</span>
</span><span id=__span-3-78><a id=__codelineno-3-78 name=__codelineno-3-78 href=#__codelineno-3-78></a><span class=w>      </span><span class=nx>citations</span><span class=o>:</span><span class=w> </span><span class=kt>context</span><span class=p>,</span>
</span><span id=__span-3-79><a id=__codelineno-3-79 name=__codelineno-3-79 href=#__codelineno-3-79></a><span class=w>      </span><span class=nx>model</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;gpt-4-turbo&#39;</span>
</span><span id=__span-3-80><a id=__codelineno-3-80 name=__codelineno-3-80 href=#__codelineno-3-80></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-3-81><a id=__codelineno-3-81 name=__codelineno-3-81 href=#__codelineno-3-81></a>
</span><span id=__span-3-82><a id=__codelineno-3-82 name=__codelineno-3-82 href=#__codelineno-3-82></a><span class=w>    </span><span class=c1>// Step 5: Return Response with Citations</span>
</span><span id=__span-3-83><a id=__codelineno-3-83 name=__codelineno-3-83 href=#__codelineno-3-83></a><span class=w>    </span><span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span><span id=__span-3-84><a id=__codelineno-3-84 name=__codelineno-3-84 href=#__codelineno-3-84></a><span class=w>      </span><span class=nx>reply</span><span class=o>:</span><span class=w> </span><span class=kt>assistantReply</span><span class=p>,</span>
</span><span id=__span-3-85><a id=__codelineno-3-85 name=__codelineno-3-85 href=#__codelineno-3-85></a><span class=w>      </span><span class=nx>citations</span><span class=o>:</span><span class=w> </span><span class=kt>context.map</span><span class=p>((</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>i</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>({</span>
</span><span id=__span-3-86><a id=__codelineno-3-86 name=__codelineno-3-86 href=#__codelineno-3-86></a><span class=w>        </span><span class=nx>index</span><span class=o>:</span><span class=w> </span><span class=kt>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mf>1</span><span class=p>,</span>
</span><span id=__span-3-87><a id=__codelineno-3-87 name=__codelineno-3-87 href=#__codelineno-3-87></a><span class=w>        </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=kt>c.title</span><span class=p>,</span>
</span><span id=__span-3-88><a id=__codelineno-3-88 name=__codelineno-3-88 href=#__codelineno-3-88></a><span class=w>        </span><span class=nx>url</span><span class=o>:</span><span class=w> </span><span class=kt>c.url</span><span class=p>,</span>
</span><span id=__span-3-89><a id=__codelineno-3-89 name=__codelineno-3-89 href=#__codelineno-3-89></a><span class=w>        </span><span class=nx>confidence</span><span class=o>:</span><span class=w> </span><span class=kt>c.score</span>
</span><span id=__span-3-90><a id=__codelineno-3-90 name=__codelineno-3-90 href=#__codelineno-3-90></a><span class=w>      </span><span class=p>}))</span>
</span><span id=__span-3-91><a id=__codelineno-3-91 name=__codelineno-3-91 href=#__codelineno-3-91></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-3-92><a id=__codelineno-3-92 name=__codelineno-3-92 href=#__codelineno-3-92></a>
</span><span id=__span-3-93><a id=__codelineno-3-93 name=__codelineno-3-93 href=#__codelineno-3-93></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-94><a id=__codelineno-3-94 name=__codelineno-3-94 href=#__codelineno-3-94></a><span class=w>    </span><span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Chat completion error:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>error</span><span class=p>);</span>
</span><span id=__span-3-95><a id=__codelineno-3-95 name=__codelineno-3-95 href=#__codelineno-3-95></a><span class=w>    </span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mf>500</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Internal server error&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-3-96><a id=__codelineno-3-96 name=__codelineno-3-96 href=#__codelineno-3-96></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-3-97><a id=__codelineno-3-97 name=__codelineno-3-97 href=#__codelineno-3-97></a><span class=p>});</span>
</span><span id=__span-3-98><a id=__codelineno-3-98 name=__codelineno-3-98 href=#__codelineno-3-98></a>
</span><span id=__span-3-99><a id=__codelineno-3-99 name=__codelineno-3-99 href=#__codelineno-3-99></a><span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=nx>router</span><span class=p>;</span>
</span></code></pre></div> <p><strong>Key Capabilities</strong>: - <strong>RAG Pipeline</strong>: Semantic search  Context injection  GPT-4 completion - <strong>RBAC Enforcement</strong>: Middleware validates <code>chat.user</code> role from Azure AD token - <strong>Observability</strong>: Application Insights tracks latency, token usage, errors - <strong>Data Residency</strong>: Cosmos DB in Canada Central, CMK encryption</p> <hr> <h2 id=4-data-flow-diagram>4. Data Flow Diagram<a class=headerlink href=#4-data-flow-diagram title="Permanent link">&para;</a></h2> <pre class=mermaid><code>sequenceDiagram
    participant User
    participant UI as React UI
    participant APIM as API Management
    participant API as EVA Foundation API
    participant AAD as Azure AD
    participant Search as Azure AI Search
    participant OpenAI as Azure OpenAI
    participant Cosmos as Cosmos DB
    participant Redis as Redis Cache

    User-&gt;&gt;UI: Enter message
    UI-&gt;&gt;AAD: Request access token
    AAD--&gt;&gt;UI: JWT token
    UI-&gt;&gt;APIM: POST /chat/completions&lt;br/&gt;(Bearer token)
    APIM-&gt;&gt;APIM: Validate JWT
    APIM-&gt;&gt;APIM: Rate limit check
    APIM-&gt;&gt;API: Forward request

    API-&gt;&gt;Redis: Check session cache
    Redis--&gt;&gt;API: Session data

    API-&gt;&gt;Search: Semantic search(message)
    Search--&gt;&gt;API: Top 5 chunks + scores

    API-&gt;&gt;OpenAI: getChatCompletions&lt;br/&gt;(context + message)
    OpenAI--&gt;&gt;API: GPT-4 response

    API-&gt;&gt;Cosmos: Store conversation
    Cosmos--&gt;&gt;API: Confirmation

    API-&gt;&gt;Redis: Update session cache
    API--&gt;&gt;APIM: Response + citations
    APIM--&gt;&gt;UI: JSON response
    UI--&gt;&gt;User: Display message + citations</code></pre> <hr> <h2 id=5-security-layers>5. Security Layers<a class=headerlink href=#5-security-layers title="Permanent link">&para;</a></h2> <h3 id=51-authentication-flow-azure-ad>5.1 Authentication Flow (Azure AD)<a class=headerlink href=#51-authentication-flow-azure-ad title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=c1>// src/config/authConfig.ts - MSAL Configuration</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Configuration</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@azure/msal-browser&#39;</span><span class=p>;</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>msalConfig</span><span class=o>:</span><span class=w> </span><span class=kt>Configuration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>  </span><span class=nx>auth</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>    </span><span class=nx>clientId</span><span class=o>:</span><span class=w> </span><span class=kt>process.env.REACT_APP_AAD_CLIENT_ID</span><span class=o>!</span><span class=p>,</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>    </span><span class=nx>authority</span><span class=o>:</span><span class=w> </span><span class=sb>`https://login.microsoftonline.com/</span><span class=si>${</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>REACT_APP_AAD_TENANT_ID</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>    </span><span class=nx>redirectUri</span><span class=o>:</span><span class=w> </span><span class=kt>window.location.origin</span><span class=p>,</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>    </span><span class=nx>postLogoutRedirectUri</span><span class=o>:</span><span class=w> </span><span class=kt>window.location.origin</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>  </span><span class=nx>cache</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>    </span><span class=nx>cacheLocation</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;sessionStorage&#39;</span><span class=p>,</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w>    </span><span class=nx>storeAuthStateInCookie</span><span class=o>:</span><span class=w> </span><span class=kt>false</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=p>};</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>loginRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=w>  </span><span class=nx>scopes</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;api://eva-foundation/.default&#39;</span><span class=p>]</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=p>};</span>
</span></code></pre></div> <p><strong>Authentication Steps</strong>: 1. User clicks "Sign In"  redirected to <code>login.microsoftonline.com</code> 2. Azure AD validates credentials, returns authorization code 3. MSAL exchanges code for access token (JWT) 4. UI attaches token to API requests via <code>Authorization: Bearer &lt;token&gt;</code> 5. API validates token signature, expiry, audience claims</p> <h3 id=52-encryption-cmk-tls>5.2 Encryption (CMK + TLS)<a class=headerlink href=#52-encryption-cmk-tls title="Permanent link">&para;</a></h3> <ul> <li><strong>Data at Rest</strong>: Cosmos DB encrypted with <strong>Customer-Managed Keys</strong> (CMK) in Azure Key Vault</li> <li><strong>Data in Transit</strong>: TLS 1.2+ enforced (no TLS 1.0/1.1), Azure Front Door terminates SSL</li> <li><strong>Key Rotation</strong>: Automated 90-day rotation for CMKs</li> </ul> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=c1>// src/services/encryption.ts - CMK Retrieval</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>SecretClient</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@azure/keyvault-secrets&#39;</span><span class=p>;</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>DefaultAzureCredential</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@azure/identity&#39;</span><span class=p>;</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=kd>const</span><span class=w> </span><span class=nx>credential</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>DefaultAzureCredential</span><span class=p>();</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=kd>const</span><span class=w> </span><span class=nx>vaultUrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>AZURE_KEYVAULT_URL</span><span class=o>!</span><span class=p>;</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=kd>const</span><span class=w> </span><span class=nx>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>SecretClient</span><span class=p>(</span><span class=nx>vaultUrl</span><span class=p>,</span><span class=w> </span><span class=nx>credential</span><span class=p>);</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>getEncryptionKey</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>string</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>secret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nx>getSecret</span><span class=p>(</span><span class=s1>&#39;cosmos-cmk&#39;</span><span class=p>);</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>secret</span><span class=p>.</span><span class=nx>value</span><span class=o>!</span><span class=p>;</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=p>}</span>
</span></code></pre></div> <h3 id=53-role-based-access-control-rbac>5.3 Role-Based Access Control (RBAC)<a class=headerlink href=#53-role-based-access-control-rbac title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1>// src/middleware/auth.ts - RBAC Middleware</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Request</span><span class=p>,</span><span class=w> </span><span class=nx>Response</span><span class=p>,</span><span class=w> </span><span class=nx>NextFunction</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=k>import</span><span class=w> </span><span class=nx>jwt</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;jsonwebtoken&#39;</span><span class=p>;</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>verifyRBAC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=nx>requiredRoles</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>[])</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=nx>req</span><span class=o>:</span><span class=w> </span><span class=kt>Request</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=o>:</span><span class=w> </span><span class=kt>Response</span><span class=p>,</span><span class=w> </span><span class=nx>next</span><span class=o>:</span><span class=w> </span><span class=kt>NextFunction</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=nx>authorization</span><span class=o>?</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>)[</span><span class=mf>1</span><span class=p>];</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>token</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mf>401</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Unauthorized&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>decoded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwt</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>token</span><span class=p>)</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>any</span><span class=p>;</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>userRoles</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>decoded</span><span class=p>.</span><span class=nx>roles</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>[];</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>hasPermission</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>requiredRoles</span><span class=p>.</span><span class=nx>some</span><span class=p>(</span><span class=nx>role</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>userRoles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>role</span><span class=p>));</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>hasPermission</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mf>403</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Forbidden&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>      </span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>decoded</span><span class=p>;</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=w>      </span><span class=nx>next</span><span class=p>();</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=w>      </span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mf>401</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Invalid token&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=w>  </span><span class=p>};</span>
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a><span class=p>};</span>
</span></code></pre></div> <p><strong>RBAC Roles</strong>: - <code>chat.user</code> - Access chat completions endpoint - <code>chat.admin</code> - View all conversations (audit) - <code>chat.analytics</code> - Export metrics</p> <hr> <h2 id=6-deployment-topology>6. Deployment Topology<a class=headerlink href=#6-deployment-topology title="Permanent link">&para;</a></h2> <p>EVA Chat 2.0 deploys to <strong>Canada Central</strong> (primary) and <strong>Canada East</strong> (failover) with Azure Front Door for global load balancing.</p> <pre class=mermaid><code>graph TB
    subgraph "Global"
        AFD[Azure Front Door&lt;br/&gt;Global Load Balancer]
    end

    subgraph "Canada Central - Primary"
        APIM_CC[API Management]
        APP_CC[App Service&lt;br/&gt;EVA Foundation API]
        AOAI_CC[Azure OpenAI&lt;br/&gt;GPT-4]
        SEARCH_CC[AI Search&lt;br/&gt;RAG Index]
        COSMOS_CC[Cosmos DB&lt;br/&gt;Primary Region]
        REDIS_CC[Redis Cache]
    end

    subgraph "Canada East - Failover"
        APIM_CE[API Management]
        APP_CE[App Service&lt;br/&gt;EVA Foundation API]
        COSMOS_CE[Cosmos DB&lt;br/&gt;Replica]
        REDIS_CE[Redis Cache]
    end

    AFD --&gt;|Route 1| APIM_CC
    AFD --&gt;|Route 2 (failover)| APIM_CE

    APIM_CC --&gt; APP_CC
    APP_CC --&gt; AOAI_CC
    APP_CC --&gt; SEARCH_CC
    APP_CC --&gt; COSMOS_CC
    APP_CC --&gt; REDIS_CC

    COSMOS_CC -.-&gt;|Geo-Replication| COSMOS_CE

    style AFD fill:#ff9999
    style APIM_CC fill:#99ccff
    style APP_CC fill:#99ccff
    style COSMOS_CC fill:#99ff99</code></pre> <p><strong>Deployment Specs</strong>: - <strong>App Service</strong>: P2v3 (2 vCPU, 8GB RAM), autoscale 2-10 instances - <strong>Azure OpenAI</strong>: Standard tier, 120K TPM quota - <strong>Cosmos DB</strong>: 10K RU/s autoscale, 99.99% SLA - <strong>Redis Cache</strong>: Standard C2 (2.5GB), 6-hour idle timeout - <strong>Monitoring</strong>: Application Insights, 90-day retention</p> <p><strong>Disaster Recovery</strong>: - <strong>RTO</strong>: 1 hour (manual failover to Canada East) - <strong>RPO</strong>: 5 minutes (Cosmos DB geo-replication lag) - <strong>Backups</strong>: Daily snapshots, 30-day retention</p> <hr> <h2 id=7-summary>7. Summary<a class=headerlink href=#7-summary title="Permanent link">&para;</a></h2> <p>EVA Chat 2.0's architecture embodies <strong>cloud-native best practices</strong> for Government of Canada deployments:</p> <ul> <li><strong>React 18 UI</strong> with EVA Sovereign UI for WCAG 2.1 AA compliance</li> <li><strong>EVA Foundation API</strong> orchestrates Azure OpenAI, AI Search, Cosmos DB</li> <li><strong>RAG Pipeline</strong> retrieves top-5 semantic chunks before GPT-4 completion</li> <li><strong>Zero-Trust Security</strong> with Azure AD, CMK encryption, TLS 1.2+, RBAC</li> <li><strong>Multi-Region Deployment</strong> in Canada Central + Canada East</li> </ul> <p>This architecture supports <strong>10,000+ concurrent users</strong>, <strong>&lt;300ms P95 latency</strong>, and <strong>99.99% uptime</strong> while maintaining Protected B data residency.</p> <p><strong>Next Chapter</strong>: <a href=./03-rag-pipeline.md>Chapter 03: RAG Pipeline</a> dives into Azure AI Search chunking strategies, semantic ranking, and hybrid retrieval.</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 MarcoPolo483 </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/MarcoPolo483/eva-orchestrator target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script> <script src=../../assets/javascripts/bundle.d7c377c4.min.js></script> <script src=../../javascripts/extra.js></script> </body> </html>